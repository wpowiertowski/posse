{{!-- Social Interactions Widget --}}
{{!-- Displays POSSE social interactions (Mastodon/Bluesky) and Webmentions --}}

<section class="social-interactions-area inner">
    {{!-- POSSE Social Interactions Widget --}}
    {{#if @custom.posse_api_url}}
    <div id="social-interactions-widget" data-post-id="{{id}}" data-api-url="{{@custom.posse_api_url}}"></div>
    {{/if}}

    {{!-- Webmentions Section --}}
    <div id="webmentions-widget" data-target="{{url absolute="true"}}" data-domain="{{@custom.webmention_domain}}">
        <div class="webmentions-container">
            <h3 class="webmentions-title">{{t "Responses"}}</h3>
            <div class="webmentions-facepile">
                <div class="webmentions-likes" id="webmentions-likes"></div>
                <div class="webmentions-reposts" id="webmentions-reposts"></div>
            </div>
            <div class="webmentions-comments" id="webmentions-comments"></div>
            <div class="webmentions-empty" id="webmentions-empty" style="display: none;">
                <p class="webmentions-empty-text">{{t "No responses yet."}}</p>
                <div class="webmentions-respond">
                    <p class="webmentions-respond-label">{{t "Join the conversation:"}}</p>
                    <div class="webmentions-respond-options" id="webmentions-respond-options">
                        {{!-- Syndicated post links will be injected here by JavaScript --}}
                    </div>
                    <a href="https://indieweb.org/webmention" target="_blank" rel="noopener" class="webmentions-info-link">
                        {{t "What are webmentions?"}}
                    </a>
                </div>
            </div>
        </div>
    </div>

    {{!-- Disqus Comments Section --}}
    {{#if @custom.enable_disqus}}
    {{#if @custom.disqus_shortname}}
    <div id="disqus_thread" class="disqus-container"></div>
    <script>
        var disqus_config = function () {
            this.page.url = '{{url absolute="true"}}';
            this.page.identifier = 'ghost-{{id}}';
        };
        (function() {
            var d = document, s = d.createElement('script');
            s.src = 'https://{{@custom.disqus_shortname}}.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    {{/if}}
    {{/if}}
</section>

<script>
(function() {
    'use strict';

    // Shared state for POSSE data (accessible by webmentions widget)
    let sharedPosseData = null;

    // ========================================
    // POSSE Social Interactions Widget
    // ========================================
    const posseWidget = document.getElementById('social-interactions-widget');

    if (posseWidget) {
        const POSSE_CONFIG = {
            apiUrl: posseWidget.dataset.apiUrl,
            postId: posseWidget.dataset.postId,
            refreshInterval: 300000
        };

        let currentData = null;

        async function fetchPosseInteractions() {
            try {
                const response = await fetch(`${POSSE_CONFIG.apiUrl}/${POSSE_CONFIG.postId}`);
                if (!response.ok) {
                    if (response.status === 404) {
                        console.log('No POSSE interaction data available yet');
                        return null;
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Failed to fetch POSSE interactions:', error);
                return null;
            }
        }

        function calculateTotals(data) {
            if (!data || !data.platforms) {
                return { likes: 0, reposts: 0, replies: 0 };
            }

            let likes = 0, reposts = 0, replies = 0;

            if (data.platforms.mastodon) {
                Object.values(data.platforms.mastodon).forEach(account => {
                    likes += account.favorites || 0;
                    reposts += account.reblogs || 0;
                    replies += account.replies || 0;
                });
            }

            if (data.platforms.bluesky) {
                Object.values(data.platforms.bluesky).forEach(account => {
                    likes += account.likes || 0;
                    reposts += account.reposts || 0;
                    replies += account.replies || 0;
                });
            }

            return { likes, reposts, replies };
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            try {
                const date = new Date(timestamp);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);

                if (diffMins < 1) return 'just now';
                if (diffMins < 60) return `${diffMins}m ago`;
                if (diffHours < 24) return `${diffHours}h ago`;
                if (diffDays < 7) return `${diffDays}d ago`;
                return date.toLocaleDateString();
            } catch (e) {
                return '';
            }
        }

        function hasAnyPlatformData(data) {
            if (!data || !data.platforms) return false;

            const hasMastodon = data.platforms.mastodon && Object.keys(data.platforms.mastodon).length > 0;
            const hasBluesky = data.platforms.bluesky && Object.keys(data.platforms.bluesky).length > 0;

            return hasMastodon || hasBluesky;
        }

        function renderPosseWidget(data) {
            const container = document.getElementById('social-interactions-widget');

            if (!data || !hasAnyPlatformData(data)) {
                container.style.display = 'none';
                return;
            }

            const totals = calculateTotals(data);

            let html = '<div class="social-interactions-container">';
            html += '<h3>Social engagement</h3>';

            // Show engagement stats (likes, reposts, replies)
            html += '<div class="engagement-summary">';
            html += `<span class="stat"><span class="stat-number">${totals.likes}</span><span class="stat-label">likes</span></span>`;
            html += `<span class="stat"><span class="stat-number">${totals.reposts}</span><span class="stat-label">reposts</span></span>`;
            html += `<span class="stat"><span class="stat-number">${totals.replies}</span><span class="stat-label">replies</span></span>`;
            html += '</div>';

            if (data.updated_at) {
                html += `<div class="last-updated">Last updated: ${formatTimestamp(data.updated_at)}</div>`;
            }

            html += '</div>';

            container.innerHTML = html;
            container.style.display = 'block';
        }

        async function initPosseWidget() {
            console.log('Initializing POSSE Social Interactions Widget');

            if (!POSSE_CONFIG.postId) {
                console.error('POSSE Widget: Post ID not configured');
                return;
            }

            if (!POSSE_CONFIG.apiUrl) {
                console.error('POSSE Widget: API URL not configured');
                return;
            }

            const data = await fetchPosseInteractions();
            if (data) {
                currentData = data;
                sharedPosseData = data;
                renderPosseWidget(data);
                // Notify webmentions widget that POSSE data is available
                window.dispatchEvent(new CustomEvent('posseDataLoaded', { detail: data }));
            }

            setInterval(async () => {
                const data = await fetchPosseInteractions();
                if (data) {
                    currentData = data;
                    sharedPosseData = data;
                    renderPosseWidget(data);
                    window.dispatchEvent(new CustomEvent('posseDataLoaded', { detail: data }));
                }
            }, POSSE_CONFIG.refreshInterval);
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initPosseWidget);
        } else {
            initPosseWidget();
        }
    }

    // ========================================
    // Webmentions Widget
    // ========================================
    const webmentionsWidget = document.getElementById('webmentions-widget');

    if (webmentionsWidget) {
        const WM_CONFIG = {
            target: webmentionsWidget.dataset.target,
            domain: webmentionsWidget.dataset.domain || 'behindtheviewfinder.com',
            refreshInterval: 300000
        };

        function escapeHtmlWm(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Convert AT Protocol URIs to HTTPS URLs (webmentions version)
        function convertAtUriToHttpsWm(atUri) {
            if (!atUri || !atUri.startsWith('at://')) {
                return atUri;
            }

            const match = atUri.match(/^at:\/\/(did:[^\/]+)\/app\.bsky\.feed\.post\/(.+)$/);
            if (match) {
                const [, did, postId] = match;
                return `https://bsky.app/profile/${did}/post/${postId}`;
            }

            return atUri;
        }

        // Extract syndicated post URLs from POSSE data
        function getSyndicatedPosts(posseData) {
            const posts = [];

            if (!posseData) return posts;

            // First check for syndication_links (preferred)
            if (posseData.syndication_links) {
                if (posseData.syndication_links.mastodon) {
                    Object.entries(posseData.syndication_links.mastodon).forEach(([accountName, accountData]) => {
                        if (accountData.post_url) {
                            posts.push({
                                platform: 'mastodon',
                                account: accountName,
                                url: convertAtUriToHttpsWm(accountData.post_url),
                                icon: '<svg class="respond-icon" viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M23.193 7.879c0-5.206-3.411-6.732-3.411-6.732C18.062.357 15.108.025 12.041 0h-.076c-3.068.025-6.02.357-7.74 1.147 0 0-3.411 1.526-3.411 6.732 0 1.192-.023 2.618.015 4.129.124 5.092.934 10.109 5.641 11.355 2.17.574 4.034.695 5.535.612 2.722-.15 4.25-.972 4.25-.972l-.09-1.975s-1.945.613-4.129.539c-2.165-.074-4.449-.233-4.799-2.891a5.499 5.499 0 0 1-.048-.745s2.125.52 4.817.643c1.646.075 3.19-.097 4.758-.283 3.007-.359 5.625-2.212 5.954-3.905.517-2.665.475-6.507.475-6.507zm-4.024 6.709h-2.497V8.469c0-1.29-.543-1.944-1.628-1.944-1.2 0-1.802.776-1.802 2.312v3.349h-2.483v-3.349c0-1.536-.602-2.312-1.802-2.312-1.085 0-1.628.655-1.628 1.944v6.119H4.832V8.284c0-1.289.328-2.313.987-3.07.68-.758 1.569-1.146 2.674-1.146 1.278 0 2.246.491 2.886 1.474L12 6.585l.622-1.043c.64-.983 1.608-1.474 2.886-1.474 1.104 0 1.994.388 2.674 1.146.658.757.986 1.781.986 3.07v6.304z"/></svg>'
                            });
                        }
                    });
                }

                if (posseData.syndication_links.bluesky) {
                    Object.entries(posseData.syndication_links.bluesky).forEach(([accountName, accountData]) => {
                        if (accountData.post_url) {
                            posts.push({
                                platform: 'bluesky',
                                account: accountName,
                                url: convertAtUriToHttpsWm(accountData.post_url),
                                icon: '<svg class="respond-icon" viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M12 10.8c-1.087-2.114-4.046-6.053-6.798-7.995C2.566.944 1.561 1.266.902 1.565.139 1.908 0 3.08 0 3.768c0 .69.378 5.65.624 6.479.815 2.736 3.713 3.66 6.383 3.364.136-.02.275-.039.415-.056-.138.022-.276.04-.415.056-3.912.58-7.387 2.005-2.83 7.078 5.013 5.19 6.87-1.113 7.823-4.308.953 3.195 2.05 9.271 7.733 4.308 4.267-4.308 1.172-6.498-2.74-7.078a8.741 8.741 0 0 1-.415-.056c.14.017.279.036.415.056 2.67.297 5.568-.628 6.383-3.364.246-.828.624-5.79.624-6.478 0-.69-.139-1.861-.902-2.206-.659-.298-1.664-.62-4.3 1.24C16.046 4.748 13.087 8.687 12 10.8z"/></svg>'
                            });
                        }
                    });
                }
            }

            // Fallback to platforms data if syndication_links not available
            if (posts.length === 0 && posseData.platforms) {
                // Extract Mastodon posts
                if (posseData.platforms.mastodon) {
                    Object.entries(posseData.platforms.mastodon).forEach(([accountName, accountData]) => {
                        if (accountData.post_url) {
                            posts.push({
                                platform: 'mastodon',
                                account: accountName,
                                url: convertAtUriToHttpsWm(accountData.post_url),
                                icon: '<svg class="respond-icon" viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M23.193 7.879c0-5.206-3.411-6.732-3.411-6.732C18.062.357 15.108.025 12.041 0h-.076c-3.068.025-6.02.357-7.74 1.147 0 0-3.411 1.526-3.411 6.732 0 1.192-.023 2.618.015 4.129.124 5.092.934 10.109 5.641 11.355 2.17.574 4.034.695 5.535.612 2.722-.15 4.25-.972 4.25-.972l-.09-1.975s-1.945.613-4.129.539c-2.165-.074-4.449-.233-4.799-2.891a5.499 5.499 0 0 1-.048-.745s2.125.52 4.817.643c1.646.075 3.19-.097 4.758-.283 3.007-.359 5.625-2.212 5.954-3.905.517-2.665.475-6.507.475-6.507zm-4.024 6.709h-2.497V8.469c0-1.29-.543-1.944-1.628-1.944-1.2 0-1.802.776-1.802 2.312v3.349h-2.483v-3.349c0-1.536-.602-2.312-1.802-2.312-1.085 0-1.628.655-1.628 1.944v6.119H4.832V8.284c0-1.289.328-2.313.987-3.07.68-.758 1.569-1.146 2.674-1.146 1.278 0 2.246.491 2.886 1.474L12 6.585l.622-1.043c.64-.983 1.608-1.474 2.886-1.474 1.104 0 1.994.388 2.674 1.146.658.757.986 1.781.986 3.07v6.304z"/></svg>'
                            });
                        }
                        // Also check split posts
                        if (accountData.split_posts) {
                            accountData.split_posts.forEach((splitPost, index) => {
                                if (splitPost.post_url && index === 0) {
                                    // Only add first split post if main post_url wasn't available
                                    if (!accountData.post_url) {
                                        posts.push({
                                            platform: 'mastodon',
                                            account: accountName,
                                            url: convertAtUriToHttpsWm(splitPost.post_url),
                                            icon: '<svg class="respond-icon" viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M23.193 7.879c0-5.206-3.411-6.732-3.411-6.732C18.062.357 15.108.025 12.041 0h-.076c-3.068.025-6.02.357-7.74 1.147 0 0-3.411 1.526-3.411 6.732 0 1.192-.023 2.618.015 4.129.124 5.092.934 10.109 5.641 11.355 2.17.574 4.034.695 5.535.612 2.722-.15 4.25-.972 4.25-.972l-.09-1.975s-1.945.613-4.129.539c-2.165-.074-4.449-.233-4.799-2.891a5.499 5.499 0 0 1-.048-.745s2.125.52 4.817.643c1.646.075 3.19-.097 4.758-.283 3.007-.359 5.625-2.212 5.954-3.905.517-2.665.475-6.507.475-6.507zm-4.024 6.709h-2.497V8.469c0-1.29-.543-1.944-1.628-1.944-1.2 0-1.802.776-1.802 2.312v3.349h-2.483v-3.349c0-1.536-.602-2.312-1.802-2.312-1.085 0-1.628.655-1.628 1.944v6.119H4.832V8.284c0-1.289.328-2.313.987-3.07.68-.758 1.569-1.146 2.674-1.146 1.278 0 2.246.491 2.886 1.474L12 6.585l.622-1.043c.64-.983 1.608-1.474 2.886-1.474 1.104 0 1.994.388 2.674 1.146.658.757.986 1.781.986 3.07v6.304z"/></svg>'
                                        });
                                    }
                                }
                            });
                        }
                    });
                }

                // Extract Bluesky posts
                if (posseData.platforms.bluesky) {
                    Object.entries(posseData.platforms.bluesky).forEach(([accountName, accountData]) => {
                        if (accountData.post_url) {
                            posts.push({
                                platform: 'bluesky',
                                account: accountName,
                                url: convertAtUriToHttpsWm(accountData.post_url),
                                icon: '<svg class="respond-icon" viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M12 10.8c-1.087-2.114-4.046-6.053-6.798-7.995C2.566.944 1.561 1.266.902 1.565.139 1.908 0 3.08 0 3.768c0 .69.378 5.65.624 6.479.815 2.736 3.713 3.66 6.383 3.364.136-.02.275-.039.415-.056-.138.022-.276.04-.415.056-3.912.58-7.387 2.005-2.83 7.078 5.013 5.19 6.87-1.113 7.823-4.308.953 3.195 2.05 9.271 7.733 4.308 4.267-4.308 1.172-6.498-2.74-7.078a8.741 8.741 0 0 1-.415-.056c.14.017.279.036.415.056 2.67.297 5.568-.628 6.383-3.364.246-.828.624-5.79.624-6.478 0-.69-.139-1.861-.902-2.206-.659-.298-1.664-.62-4.3 1.24C16.046 4.748 13.087 8.687 12 10.8z"/></svg>'
                            });
                        }
                        // Also check split posts
                        if (accountData.split_posts) {
                            accountData.split_posts.forEach((splitPost, index) => {
                                if (splitPost.post_url && index === 0) {
                                    if (!accountData.post_url) {
                                        posts.push({
                                            platform: 'bluesky',
                                            account: accountName,
                                            url: convertAtUriToHttpsWm(splitPost.post_url),
                                            icon: '<svg class="respond-icon" viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M12 10.8c-1.087-2.114-4.046-6.053-6.798-7.995C2.566.944 1.561 1.266.902 1.565.139 1.908 0 3.08 0 3.768c0 .69.378 5.65.624 6.479.815 2.736 3.713 3.66 6.383 3.364.136-.02.275-.039.415-.056-.138.022-.276.04-.415.056-3.912.58-7.387 2.005-2.83 7.078 5.013 5.19 6.87-1.113 7.823-4.308.953 3.195 2.05 9.271 7.733 4.308 4.267-4.308 1.172-6.498-2.74-7.078a8.741 8.741 0 0 1-.415-.056c.14.017.279.036.415.056 2.67.297 5.568-.628 6.383-3.364.246-.828.624-5.79.624-6.478 0-.69-.139-1.861-.902-2.206-.659-.298-1.664-.62-4.3 1.24C16.046 4.748 13.087 8.687 12 10.8z"/></svg>'
                                        });
                                    }
                                }
                            });
                        }
                    });
                }
            }

            return posts;
        }

        // Render respond options in the empty state
        function renderRespondOptions(posseData) {
            const container = document.getElementById('webmentions-respond-options');
            if (!container) return;

            let html = '';
            const syndicatedPosts = getSyndicatedPosts(posseData);

            // Group posts by platform
            const mastodonPosts = syndicatedPosts.filter(p => p.platform === 'mastodon');
            const blueskyPosts = syndicatedPosts.filter(p => p.platform === 'bluesky');

            // Mastodon row
            if (mastodonPosts.length > 0) {
                html += '<div class="webmentions-respond-row">';
                mastodonPosts.forEach(post => {
                    html += `<a href="${escapeHtmlWm(post.url)}" target="_blank" rel="noopener" class="respond-option respond-option-mastodon">`;
                    html += post.icon;
                    html += ' <span>Reply on Mastodon</span>';
                    html += '</a>';
                });
                html += '</div>';
            }

            // Bluesky row
            if (blueskyPosts.length > 0) {
                html += '<div class="webmentions-respond-row">';
                blueskyPosts.forEach(post => {
                    html += `<a href="${escapeHtmlWm(post.url)}" target="_blank" rel="noopener" class="respond-option respond-option-bluesky">`;
                    html += post.icon;
                    html += ' <span>Reply on Bluesky</span>';
                    html += '</a>';
                });
                html += '</div>';
            }

            // Webmention row
            const webmentionFormUrl = `https://commentpara.de/?url=${encodeURIComponent(WM_CONFIG.target)}`;
            html += '<div class="webmentions-respond-row">';
            html += `<a href="${webmentionFormUrl}" target="_blank" rel="noopener" class="respond-option respond-option-webmention">`;
            html += '<svg class="respond-icon" viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>';
            html += ' <span>Send a Webmention</span>';
            html += '</a>';
            html += '</div>';

            container.innerHTML = html;
        }

        function formatTimestampWm(timestamp) {
            if (!timestamp) return '';
            try {
                const date = new Date(timestamp);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);

                if (diffMins < 1) return 'just now';
                if (diffMins < 60) return `${diffMins}m ago`;
                if (diffHours < 24) return `${diffHours}h ago`;
                if (diffDays < 7) return `${diffDays}d ago`;
                return date.toLocaleDateString();
            } catch (e) {
                return '';
            }
        }

        async function fetchWebmentions() {
            try {
                const url = `https://webmention.io/api/mentions.jf2?target=${encodeURIComponent(WM_CONFIG.target)}&per-page=100`;
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Failed to fetch webmentions:', error);
                return null;
            }
        }

        function categorizeWebmentions(data) {
            const categories = {
                likes: [],
                reposts: [],
                comments: [],
                mentions: []
            };

            if (!data || !data.children) return categories;

            data.children.forEach(mention => {
                const type = mention['wm-property'];
                switch (type) {
                    case 'like-of':
                        categories.likes.push(mention);
                        break;
                    case 'repost-of':
                        categories.reposts.push(mention);
                        break;
                    case 'in-reply-to':
                        categories.comments.push(mention);
                        break;
                    case 'mention-of':
                    case 'bookmark-of':
                        categories.mentions.push(mention);
                        break;
                    default:
                        categories.mentions.push(mention);
                }
            });

            return categories;
        }

        function renderFacepile(items, containerId, label) {
            const container = document.getElementById(containerId);
            if (!container || items.length === 0) {
                if (container) container.style.display = 'none';
                return;
            }

            let html = `<div class="facepile-group">`;
            html += `<span class="facepile-label">${items.length} ${label}</span>`;
            html += `<div class="facepile-avatars">`;

            const displayItems = items.slice(0, 20);
            displayItems.forEach(item => {
                const author = item.author || {};
                const name = escapeHtmlWm(author.name || 'Anonymous');
                const photo = author.photo || '';
                const url = author.url || item.url || '#';

                if (photo) {
                    html += `<a href="${escapeHtmlWm(url)}" target="_blank" rel="noopener" title="${name}">`;
                    html += `<img src="${escapeHtmlWm(photo)}" alt="${name}" class="facepile-avatar" loading="lazy">`;
                    html += `</a>`;
                } else {
                    html += `<a href="${escapeHtmlWm(url)}" target="_blank" rel="noopener" title="${name}" class="facepile-avatar facepile-avatar-placeholder">`;
                    html += name.charAt(0).toUpperCase();
                    html += `</a>`;
                }
            });

            if (items.length > 20) {
                html += `<span class="facepile-more">+${items.length - 20}</span>`;
            }

            html += `</div></div>`;
            container.innerHTML = html;
            container.style.display = 'block';
        }

        // Extract reply previews from POSSE data
        function getPosseReplies(posseData) {
            const replies = [];

            if (!posseData || !posseData.platforms) return replies;

            // Extract Mastodon replies
            if (posseData.platforms.mastodon) {
                Object.values(posseData.platforms.mastodon).forEach(account => {
                    if (account.reply_previews && Array.isArray(account.reply_previews)) {
                        account.reply_previews.forEach(reply => {
                            replies.push({
                                type: 'posse',
                                platform: 'mastodon',
                                author: reply.author || 'Anonymous',
                                authorAvatar: reply.author_avatar || '',
                                authorUrl: reply.author_url || '#',
                                content: reply.content || '',
                                timestamp: reply.created_at,
                                url: reply.url || '#'
                            });
                        });
                    }
                });
            }

            // Extract Bluesky replies
            if (posseData.platforms.bluesky) {
                Object.values(posseData.platforms.bluesky).forEach(account => {
                    if (account.reply_previews && Array.isArray(account.reply_previews)) {
                        account.reply_previews.forEach(reply => {
                            replies.push({
                                type: 'posse',
                                platform: 'bluesky',
                                author: reply.author || 'Anonymous',
                                authorAvatar: reply.author_avatar || '',
                                authorUrl: reply.author_url || '#',
                                content: reply.content || '',
                                timestamp: reply.created_at,
                                url: reply.url || '#'
                            });
                        });
                    }
                });
            }

            return replies;
        }

        function renderWebmentionComments(comments, posseReplies = [], posseData = null) {
            const container = document.getElementById('webmentions-comments');

            // Combine webmention comments and POSSE replies
            const allReplies = [...posseReplies];

            // Add webmention comments
            comments.forEach(comment => {
                const author = comment.author || {};
                allReplies.push({
                    type: 'webmention',
                    author: author.name || 'Anonymous',
                    authorAvatar: author.photo || '',
                    authorUrl: author.url || '#',
                    content: comment.content ? (comment.content.html || comment.content.text || '') : '',
                    timestamp: comment.published || comment['wm-received'],
                    url: comment.url || comment['wm-source'] || '#'
                });
            });

            if (!container || allReplies.length === 0) {
                if (container) container.style.display = 'none';
                return;
            }

            // Sort by timestamp (newest first)
            allReplies.sort((a, b) => {
                const dateA = new Date(a.timestamp || 0);
                const dateB = new Date(b.timestamp || 0);
                return dateB - dateA;
            });

            let html = '<h4>Comments & Replies</h4>';

            allReplies.forEach(reply => {
                const name = escapeHtmlWm(reply.author);
                const photo = reply.authorAvatar;
                const authorUrl = reply.authorUrl;
                const content = reply.content;
                const timestamp = reply.timestamp;
                const sourceUrl = reply.url;

                html += `<div class="webmention-comment">`;
                html += `<div class="webmention-comment-header">`;

                if (photo) {
                    html += `<img src="${escapeHtmlWm(photo)}" alt="${name}" class="webmention-avatar" loading="lazy">`;
                } else {
                    html += `<span class="webmention-avatar webmention-avatar-placeholder">${name.charAt(0).toUpperCase()}</span>`;
                }

                html += `<div class="webmention-meta">`;
                html += `<a href="${escapeHtmlWm(authorUrl)}" target="_blank" rel="noopener" class="webmention-author">${name}</a>`;
                html += ` <span class="webmention-time">${formatTimestampWm(timestamp)}</span>`;
                html += `</div>`;
                html += `</div>`;

                if (content) {
                    if (reply.type === 'posse') {
                        // For POSSE replies, escape and preserve line breaks
                        const escapedContent = escapeHtmlWm(content).replace(/\n/g, '<br>');
                        html += `<div class="webmention-content">${escapedContent}</div>`;
                    } else {
                        // For webmentions, sanitize HTML content
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = content;
                        tempDiv.querySelectorAll('script').forEach(el => el.remove());
                        const sanitized = tempDiv.innerHTML;
                        html += `<div class="webmention-content">${sanitized}</div>`;
                    }
                }

                html += `<a href="${escapeHtmlWm(sourceUrl)}" target="_blank" rel="noopener" class="webmention-source-link">View source â†’</a>`;
                html += `</div>`;
            });

            // Add respond options at the end
            html += '<div class="webmentions-respond">';
            html += '<p class="webmentions-respond-label">Join the conversation:</p>';

            const syndicatedPosts = getSyndicatedPosts(posseData);

            // Group posts by platform
            const mastodonPosts = syndicatedPosts.filter(p => p.platform === 'mastodon');
            const blueskyPosts = syndicatedPosts.filter(p => p.platform === 'bluesky');

            // Mastodon row
            if (mastodonPosts.length > 0) {
                html += '<div class="webmentions-respond-row">';
                mastodonPosts.forEach(post => {
                    html += `<a href="${escapeHtmlWm(post.url)}" target="_blank" rel="noopener" class="respond-option respond-option-mastodon">`;
                    html += post.icon;
                    html += ' <span>Reply on Mastodon</span>';
                    html += '</a>';
                });
                html += '</div>';
            }

            // Bluesky row
            if (blueskyPosts.length > 0) {
                html += '<div class="webmentions-respond-row">';
                blueskyPosts.forEach(post => {
                    html += `<a href="${escapeHtmlWm(post.url)}" target="_blank" rel="noopener" class="respond-option respond-option-bluesky">`;
                    html += post.icon;
                    html += ' <span>Reply on Bluesky</span>';
                    html += '</a>';
                });
                html += '</div>';
            }

            // Webmention row
            const webmentionFormUrl = `https://commentpara.de/?url=${encodeURIComponent(WM_CONFIG.target)}`;
            html += '<div class="webmentions-respond-row">';
            html += `<a href="${webmentionFormUrl}" target="_blank" rel="noopener" class="respond-option respond-option-webmention">`;
            html += '<svg class="respond-icon" viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>';
            html += ' <span>Send a Webmention</span>';
            html += '</a>';
            html += '</div>';

            html += `<a href="https://indieweb.org/webmention" target="_blank" rel="noopener" class="webmentions-info-link">What are webmentions?</a>`;
            html += '</div>';

            container.innerHTML = html;
            container.style.display = 'block';
        }

        function renderWebmentions(data) {
            const categories = categorizeWebmentions(data);
            const emptyContainer = document.getElementById('webmentions-empty');

            // Get POSSE replies
            const posseReplies = getPosseReplies(sharedPosseData);

            const totalMentions = categories.likes.length + categories.reposts.length +
                                  categories.comments.length + categories.mentions.length + posseReplies.length;

            if (totalMentions === 0) {
                if (emptyContainer) {
                    emptyContainer.style.display = 'block';
                    // Render respond options with current POSSE data
                    renderRespondOptions(sharedPosseData);
                }
                return;
            }

            if (emptyContainer) emptyContainer.style.display = 'none';

            renderFacepile(categories.likes, 'webmentions-likes', 'likes');
            renderFacepile(categories.reposts, 'webmentions-reposts', 'reposts');
            renderWebmentionComments([...categories.comments, ...categories.mentions], posseReplies, sharedPosseData);
        }

        let cachedWebmentionsData = null;

        async function initWebmentions() {
            console.log('Initializing Webmentions Widget');

            if (!WM_CONFIG.target) {
                console.error('Webmentions Widget: Target URL not configured');
                return;
            }

            const data = await fetchWebmentions();
            cachedWebmentionsData = data;
            if (data) {
                renderWebmentions(data);
            }

            // Listen for POSSE data updates to refresh respond options AND re-render comments
            window.addEventListener('posseDataLoaded', (event) => {
                // Re-render webmentions to include POSSE replies
                if (cachedWebmentionsData) {
                    renderWebmentions(cachedWebmentionsData);
                }
                // Also update respond options in empty state
                const emptyContainer = document.getElementById('webmentions-empty');
                if (emptyContainer && emptyContainer.style.display !== 'none') {
                    renderRespondOptions(event.detail);
                }
            });

            setInterval(async () => {
                const data = await fetchWebmentions();
                cachedWebmentionsData = data;
                if (data) {
                    renderWebmentions(data);
                }
            }, WM_CONFIG.refreshInterval);
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initWebmentions);
        } else {
            initWebmentions();
        }
    }
})();
</script>
