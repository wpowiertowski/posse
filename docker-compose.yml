services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: posse 
    volumes:
      - .:/app
      - ./config.yml:/app/config.yml:ro
    secrets:
      - pushover_app_token
      - pushover_user_key
    command: poetry run posse
    stdin_open: true
    tty: true

  test:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: posse-test
    volumes:
      - .:/app
      - ./config.yml:/app/config.yml:ro
    command: poetry run pytest
    profiles:
      - test

  # Mastodon OAuth Setup Services
  # Run these services interactively to set up Mastodon OAuth credentials
  
  mastodon-register:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: posse-mastodon-register
    volumes:
      - ./secrets:/secrets
    command: >
      python3 -c "
      from mastodon_client.mastodon_client import MastodonClient;
      import os;
      instance = os.environ.get('MASTODON_INSTANCE', 'https://mastodon.social');
      print(f'\\nðŸ”§ Registering POSSE with {instance}...');
      client_id, client_secret = MastodonClient.register_app(
        app_name='POSSE',
        instance_url=instance,
        to_file='/secrets/mastodon_client.secret'
      );
      print(f'\\nâœ… App registered successfully!');
      print(f'ðŸ“ Client credentials saved to secrets/mastodon_client.secret');
      print('\\nâ–¶ï¸  Next step - Run OAuth authorization');
      print('   docker compose run --rm mastodon-oauth');
      "
    environment:
      - MASTODON_INSTANCE=${MASTODON_INSTANCE:-https://mastodon.social}
    profiles:
      - mastodon-setup
  
  mastodon-oauth:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: posse-mastodon-oauth
    volumes:
      - ./secrets:/secrets
    stdin_open: true
    tty: true
    command: >
      python3 -c "
      from mastodon_client.mastodon_client import MastodonClient;
      import os;
      instance = os.environ.get('MASTODON_INSTANCE', 'https://mastodon.social');
      print(f'\\nðŸ” Starting OAuth authorization for {instance}...');
      client = MastodonClient.create_for_oauth(
        client_credential_file='/secrets/mastodon_client.secret',
        instance_url=instance
      );
      auth_url = client.get_auth_request_url();
      print(f'\\nðŸ“‹ Step 1 - Visit this URL to authorize POSSE');
      print(f'\\n{auth_url}\\n');
      print(f'ðŸ“‹ Step 2 - After authorizing, copy the code and paste it below');
      code = input('\\nðŸ”‘ Enter authorization code: ').strip();
      access_token = client.login_with_code(
        code=code,
        to_file='/secrets/mastodon_access_token.txt'
      );
      print(f'\\nâœ… Access token saved to secrets/mastodon_access_token.txt');
      print('\\nâ–¶ï¸  Next step - Test posting with mastodon-test');
      print('   docker compose run --rm mastodon-test');
      "
    environment:
      - MASTODON_INSTANCE=${MASTODON_INSTANCE:-https://mastodon.social}
    profiles:
      - mastodon-setup

  mastodon-test:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: posse-mastodon-test
    volumes:
      - ./secrets:/secrets
    command: >
      python3 -c "
      from mastodon_client.mastodon_client import MastodonClient;
      import os;
      instance = os.environ.get('MASTODON_INSTANCE', 'https://mastodon.social');
      print(f'\\nðŸš€ Testing Mastodon posting to {instance}...');
      with open('/secrets/mastodon_access_token.txt', 'r') as f:
        access_token = f.read().strip();
      client = MastodonClient(
        instance_url=instance,
        access_token=access_token
      );
      result = client.toot('ðŸš€ Hello from POSSE! Testing OAuth integration.');
      if result:
        print(f'\\nâœ… Successfully posted!');
        print(f'ðŸ”— View at - {result[\"url\"]}');
        print('\\nâ–¶ï¸  Setup complete! Enable Mastodon in config.yml to start using POSSE');
      else:
        print('\\nâŒ Posting failed. Check your credentials.');
      "
    environment:
      - MASTODON_INSTANCE=${MASTODON_INSTANCE:-https://mastodon.social}
    profiles:
      - mastodon-setup

# Docker secrets for Pushover credentials
# To use secrets:
# 1. Create secrets directory and secret files with your credentials:
#    mkdir -p secrets
#    printf '%s' 'YOUR_ACTUAL_APP_TOKEN_HERE' > secrets/pushover_app_token.txt
#    printf '%s' 'YOUR_ACTUAL_USER_KEY_HERE' > secrets/pushover_user_key.txt
# 2. Set pushover.enabled to true in config.yml
secrets:
  pushover_app_token:
    file: ./secrets/pushover_app_token.txt
  pushover_user_key:
    file: ./secrets/pushover_user_key.txt
